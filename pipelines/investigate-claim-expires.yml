name: Investigate claim expires

queries:

- name: claim-expired
  type: gcp-query
  query: |
    jsonPayload.Type="task-exception"
    jsonPayload.Logger="taskcluster.queue.claim-resolver"
  extract:
    taskId: jsonPayload.Fields.taskId

- name: fetch task data
  description: take entries from previous query and fetch task data
  type: taskcluster-lookup-tasks
  field: taskId

- name: analyze task queues
  type: summarize
  fields:
    taskQueue: taskQueueId
    taskGroup: taskGroupId
    scheduler: scheduler
    taskId: taskId
    name: metadata.name
    runs: runLength

- name: check workers
  type: gcp-query-multi
  iterate:
    workerId: workerIds
  query: |
    jsonPayload.Type="monitor.apiMethod"
    "%workerId%"

  description: |
    workers only have "claimWork" as their last known call to the system

  extract:
    type: jsonPayload.Type
    taskId: jsonPayload.Fields.taskId
    time: timestamp
    name: jsonPayload.Fields.name
    clientId: jsonPayload.Fields.clientId
